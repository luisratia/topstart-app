<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Admin Louis | Top Star</title>
    <style>
        body { font-family: sans-serif; background: #0f172a; color: white; padding: 20px; }
        .card { background: #1e293b; padding: 20px; border-radius: 10px; max-width: 800px; margin: auto; }
        input, select { padding: 10px; margin: 5px; border-radius: 5px; border: none; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #334155; padding: 10px; text-align: left; }
        .btn-save { background: #22c55e; color: white; padding: 15px; width: 100%; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; margin-top: 20px; }
        .btn-add { background: #3b82f6; color: white; border: none; padding: 10px; border-radius: 5px; cursor: pointer; }
    </style>
</head>
<body>
    <div class="card">
        <h2>Panel de Inventario - Neon DB</h2>
        <label>Tasa COP:</label>
        <input type="number" id="tasa" value="4050">
        <hr>
        <h3>Agregar Producto</h3>
        <input type="text" id="es" placeholder="Nombre (EspaÃ±ol)">
        <input type="text" id="en" placeholder="Name (English)">
        <input type="number" id="price" placeholder="Precio USD" step="0.01">
        <select id="cat">
            <option value="VÃ­veres">VÃ­veres</option>
            <option value="Limpieza">Limpieza</option>
            <option value="Bebidas">Bebidas</option>
            <option value="Licores">Licores</option>
            <option value="Carnes">Carnes</option>
            <option value="CharcuterÃ­a">CharcuterÃ­a</option>
            <option value="FerreterÃ­a">FerreterÃ­a</option>
            <option value="Varios">Varios</option>
        </select>
        <button class="btn-add" onclick="agregar()">AÃ±adir a lista</button>

        <table id="tabla">
            <thead><tr><th>Cat</th><th>Producto</th><th>Precio $</th><th>AcciÃ³n</th></tr></thead>
            <tbody></tbody>
        </table>

        <button class="btn-save" id="btnPublicar" onclick="guardar()">ðŸš€ PUBLICAR CAMBIOS EN LA NUBE</button>
    </div>

    <script>
        let productos = [];
        
        async function cargar() {
            try {
                const res = await fetch('/api');
                const data = await res.json();
                productos = data.productos || [];
                document.getElementById('tasa').value = data.tasa || 4050;
                render();
            } catch (err) {
                console.error("Error cargando datos:", err);
            }
        }

        function agregar() {
            const inputEs = document.getElementById('es');
            const inputEn = document.getElementById('en');
            const inputPrice = document.getElementById('price');
            const inputCat = document.getElementById('cat');

            const p = {
                id: Date.now(),
                es: inputEs.value,
                en: inputEn.value,
                price: parseFloat(inputPrice.value),
                cat: inputCat.value
            };

            if(p.es && p.price) { 
                productos.push(p); 
                // Limpiar campos para el siguiente producto
                inputEs.value = '';
                inputEn.value = '';
                inputPrice.value = '';
                render(); 
            } else {
                alert("Por favor llena al menos el nombre y el precio.");
            }
        }

        function render() {
            const tbody = document.querySelector('#tabla tbody');
            tbody.innerHTML = productos.map((p, i) => `
                <tr>
                    <td>${p.cat}</td>
                    <td>${p.es}</td>
                    <td><input type="number" value="${p.price}" onchange="productos[${i}].price=parseFloat(this.value)" style="width:70px"></td>
                    <td><button onclick="productos.splice(${i},1); render()" style="background:#ef4444; color:white; border:none; border-radius:3px; cursor:pointer">Eliminar</button></td>
                </tr>
            `).join('');
        }

        async function guardar() {
            const btn = document.getElementById('btnPublicar');
            const originalText = btn.innerText;
            
            try {
                btn.innerText = "Sincronizando con Neon...";
                btn.disabled = true;

                const datosParaEnviar = { 
                    tasa: parseFloat(document.getElementById('tasa').value), 
                    productos: productos 
                };

                const res = await fetch('/api', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }, // Indispensable para Cloudflare
                    body: JSON.stringify(datosParaEnviar)
                });

                if (res.ok) {
                    alert("Â¡Base de datos Neon actualizada con Ã©xito!");
                } else {
                    throw new Error("Error en el servidor");
                }
            } catch (error) {
                alert("Hubo un error al guardar los datos.");
                console.error(error);
            } finally {
                btn.innerText = originalText;
                btn.disabled = false;
            }
        }

        window.onload = cargar;
    </script>
</body>
</html>